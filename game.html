<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hide & Seek â€“ Game</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Editable -->
<script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #000;
}

#map { height: 100%; width: 100%; }

/* ===== HEADER ===== */
header {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 56px;
  backdrop-filter: blur(18px);
  background: rgba(255,255,255,0.75);
  display: flex; align-items: center; gap: 8px;
  padding: 0 14px; z-index: 1000;
}

header input, header select {
  padding: 6px 10px; border-radius: 10px;
  border: 1px solid #ccc; font-size: 14px;
}

header button {
  padding: 6px 12px; border-radius: 10px;
  border: none; background: #007aff;
  color: #fff; font-weight: 600; cursor: pointer;
}

/* ===== SEEKER CONTROLS ===== */
#seekerControls {
  position: fixed; bottom: 16px;
  left: 50%; transform: translateX(-50%);
  background: rgba(255,255,255,0.9);
  padding: 12px 16px;
  border-radius: 16px;
  backdrop-filter: blur(14px);
  z-index: 1000; display: none;
}

/* ===== MARKERS ===== */
.player-marker {
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 3px solid white;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
}

.seeker-marker { background-color: #ff3b30; }
.hider-marker { background-color: #007aff; }

/* ðŸ”¥ FIX FOR RECTANGLE BUG */
.leaflet-div-icon {
  background: transparent !important;
  border: none !important;
}
</style>
</head>

<body>

<header>
  <input id="nameInput" placeholder="Your name" />
  <button onclick="saveName()">Save</button>
  <select id="roleSelect" onchange="changeRole()">
    <option value="hider">Hider</option>
    <option value="seeker">Seeker</option>
  </select>
</header>

<div id="seekerControls">
  <label>
    Radius:
    <input type="range" min="50" max="500" step="10" id="radiusSlider"/>
  </label>
  <label style="margin-left:10px;">
    Circle Color:
    <input type="color" id="circleColor" value="#ff3b30"/>
  </label>
</div>

<div id="map"></div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  databaseURL: "https://hide-seek-demo-f6c65-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== USER ===== */
const playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

let playerName = localStorage.getItem("playerName") || "";
let role = localStorage.getItem("playerRole") || "hider";
document.getElementById("nameInput").value = playerName;
document.getElementById("roleSelect").value = role;

/* ===== MAP ===== */
const map = L.map("map", { editable: true }).setView([0, 0], 18);

/* Satellite + labels */
L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { maxZoom: 22 }).addTo(map);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png", { maxZoom: 22 }).addTo(map);

/* ===== MARKERS ===== */
const markers = {};
let seekerCircle = null;

/* ===== ICON FACTORY ===== */
function getIcon(r) {
  return L.divIcon({
    className: "",
    html: `<div class="player-marker ${r}-marker"></div>`,
    iconSize: [20, 20],
    iconAnchor: [10, 10]
  });
}

/* ===== LOCATION ===== */
navigator.geolocation.watchPosition(
  pos => {
    const { latitude, longitude } = pos.coords;
    map.setView([latitude, longitude], map.getZoom());

    db.ref("players/" + playerId).set({
      name: playerName || "Player",
      role,
      lat: latitude,
      lng: longitude
    });
  },
  err => alert("Location error: " + err.message),
  { enableHighAccuracy: true }
);

/* ===== LISTEN PLAYERS ===== */
db.ref("players").on("value", snap => {
  const data = snap.val() || {};

  Object.keys(data).forEach(id => {
    const p = data[id];
    if (!markers[id]) {
      markers[id] = L.marker([p.lat, p.lng], { icon: getIcon(p.role) }).addTo(map);
    } else {
      markers[id].setLatLng([p.lat, p.lng]);
      markers[id].setIcon(getIcon(p.role));
    }
    markers[id].bindPopup(`<b>${p.name}</b><br>${p.role}`);
  });
});

/* ===== NAME ===== */
function saveName() {
  playerName = document.getElementById("nameInput").value.trim();
  localStorage.setItem("playerName", playerName);
}

/* ===== ROLE ===== */
function changeRole() {
  role = document.getElementById("roleSelect").value;
  localStorage.setItem("playerRole", role);

  if (role === "seeker") {
    document.getElementById("seekerControls").style.display = "block";
    enableSeekerCircle();
  } else {
    document.getElementById("seekerControls").style.display = "none";
    removeSeekerCircle();
  }
}

/* ===== SEEKER CIRCLE ===== */
const colorInput = document.getElementById("circleColor");
let seekerColor = localStorage.getItem("seekerColor") || "#ff3b30";
colorInput.value = seekerColor;

colorInput.addEventListener("input", () => {
  seekerColor = colorInput.value;
  localStorage.setItem("seekerColor", seekerColor);
  if (seekerCircle) {
    seekerCircle.setStyle({ color: seekerColor, fillColor: seekerColor });
  }
});

function enableSeekerCircle() {
  if (seekerCircle) return;

  seekerCircle = L.circle(map.getCenter(), {
    radius: 150,
    color: seekerColor,
    fillColor: seekerColor,
    fillOpacity: 0.15
  }).addTo(map);

  seekerCircle.enableEdit();

  document.getElementById("radiusSlider").value = 150;
  document.getElementById("radiusSlider").oninput = e => {
    seekerCircle.setRadius(e.target.value);
  };
}

function removeSeekerCircle() {
  if (seekerCircle) {
    map.removeLayer(seekerCircle);
    seekerCircle = null;
  }
}

/* ===== INIT ===== */
if (role === "seeker") {
  document.getElementById("seekerControls").style.display = "block";
  enableSeekerCircle();
}
</script>

</body>
</html>
