<!DOCTYPE html>
<html>
<head>
  <title>Hide & Seek — Game</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Editable -->
  <script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:100%; width:100%; }

    .glass {
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.35);
      backdrop-filter:blur(18px);
      padding:10px 16px;
      border-radius:20px;
      z-index:1000;
      font-weight:600;
    }

    #radiusBox {
      position:absolute;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.35);
      backdrop-filter:blur(18px);
      padding:12px 16px;
      border-radius:20px;
      z-index:1000;
      display:none;
    }
  </style>
</head>

<body>

<div class="glass" id="topBar"></div>

<div id="radiusBox">
  <b>Seeker Radius</b><br>
  <input type="range" id="radiusSlider" min="50" max="500" value="150">
  <span id="radiusValue">150 m</span>
</div>

<div id="map"></div>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD259A37SrWNP8jaRP7h3NLKQMIAsr5jC4",
  authDomain: "hide-seek-demo-f6c65.firebaseapp.com",
  databaseURL: "https://hide-seek-demo-f6c65-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hide-seek-demo-f6c65",
  storageBucket: "hide-seek-demo-f6c65.firebasestorage.app",
  messagingSenderId: "457844478016",
  appId: "1:457844478016:web:7e576a496bea1fe03d8fa5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Player identity */
let playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

let name = localStorage.getItem("playerName");
let role = localStorage.getItem("playerRole");

if (!name || !role) {
  name = prompt("Enter your name");
  role = prompt("Type: seeker or hider").toLowerCase();
  localStorage.setItem("playerName", name);
  localStorage.setItem("playerRole", role);
}

/* UI */
document.getElementById("topBar").textContent =
  `${name} — ${role.toUpperCase()}`;

/* Map */
const map = L.map("map", { editable:true }).setView([6.033,80.216], 18);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 20 }
).addTo(map);

L.tileLayer(
  "https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png",
  { maxZoom: 20 }
).addTo(map);

/* Players */
const markers = {};

/* Location tracking */
navigator.geolocation.watchPosition(pos => {
  set(ref(db, "players/"+playerId), {
    name,
    role,
    lat: pos.coords.latitude,
    lon: pos.coords.longitude,
    last: Date.now()
  });
});

/* Render players */
onValue(ref(db,"players"), snap => {
  const players = snap.val() || {};
  for (const id in players) {
    const p = players[id];
    const color = p.role === "seeker" ? "red" : "blue";

    const icon = L.divIcon({
      html:`<div style="background:${color};width:14px;height:14px;border-radius:50%"></div>
            <div style="font-size:12px;font-weight:600">${p.name}</div>`,
      iconSize:[14,14]
    });

    if (!markers[id]) {
      markers[id] = L.marker([p.lat,p.lon],{icon}).addTo(map);
    } else {
      markers[id].setLatLng([p.lat,p.lon]);
    }
  }
});

/* Seeker zone */
let circle = null;
const slider = document.getElementById("radiusSlider");
const radiusValue = document.getElementById("radiusValue");
const box = document.getElementById("radiusBox");

if (role === "seeker") box.style.display = "block";

/* Sync zone */
onValue(ref(db,"game/zone"), snap => {
  const z = snap.val();
  if (!z) return;

  if (!circle) {
    circle = L.circle([z.lat,z.lon], {
      radius:z.radius,
      color:"red",
      fillOpacity:0.15
    }).addTo(map);

    if (role === "seeker") circle.enableEdit();
  } else {
    circle.setLatLng([z.lat,z.lon]);
    circle.setRadius(z.radius);
  }

  slider.value = z.radius;
  radiusValue.textContent = z.radius+" m";
});

/* Seeker updates */
if (role === "seeker") {
  map.on("editable:dragend", () => {
    const c = circle.getLatLng();
    set(ref(db,"game/zone"), {
      lat:c.lat,
      lon:c.lng,
      radius:circle.getRadius()
    });
  });

  slider.oninput = () => {
    radiusValue.textContent = slider.value+" m";
    circle.setRadius(slider.value);
    const c = circle.getLatLng();
    set(ref(db,"game/zone"), {
      lat:c.lat,
      lon:c.lng,
      radius:Number(slider.value)
    });
  };
}
</script>

</body>
</html>
