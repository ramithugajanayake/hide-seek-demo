<!DOCTYPE html>
<html>
<head>
  <title>Hide & Seek — Game</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Editable -->
  <script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { height:100%; width:100%; }

    .glass {
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.35);
      backdrop-filter:blur(18px);
      padding:10px 16px;
      border-radius:20px;
      z-index:1000;
      font-weight:700;
    }

    .settings {
      position:absolute;
      top:12px;
      right:12px;
      cursor:pointer;
      background:rgba(255,255,255,0.35);
      backdrop-filter:blur(18px);
      padding:8px 12px;
      border-radius:16px;
      z-index:1000;
      font-weight:600;
    }

    #radiusBox {
      position:absolute;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.35);
      backdrop-filter:blur(18px);
      padding:12px 16px;
      border-radius:20px;
      z-index:1000;
      display:none;
    }

    #settingsModal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }

    #settingsModal > div {
      background:rgba(255,255,255,0.4);
      backdrop-filter:blur(20px);
      padding:20px;
      border-radius:20px;
      min-width:260px;
    }

    input, select, button {
      width:100%;
      padding:6px;
      margin-top:4px;
      margin-bottom:10px;
    }
  </style>
</head>

<body>

<div class="glass" id="topBar"></div>
<div class="settings" onclick="openSettings()">⚙️</div>

<div id="radiusBox">
  <b>Seeker Radius</b><br>
  <input type="range" id="radiusSlider" min="50" max="500" value="150">
  <span id="radiusValue">150 m</span>
</div>

<div id="map"></div>

<!-- Settings Modal -->
<div id="settingsModal">
  <div>
    <h3>Player Settings</h3>

    <label>Name</label>
    <input id="nameInput">

    <label>Role</label>
    <select id="roleInput">
      <option value="seeker">Seeker</option>
      <option value="hider">Hider</option>
    </select>

    <button onclick="saveSettings()">Save</button>
    <button onclick="closeSettings()">Cancel</button>
  </div>
</div>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD259A37SrWNP8jaRP7h3NLKQMIAsr5jC4",
  authDomain: "hide-seek-demo-f6c65.firebaseapp.com",
  databaseURL: "https://hide-seek-demo-f6c65-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hide-seek-demo-f6c65",
  storageBucket: "hide-seek-demo-f6c65.firebasestorage.app",
  messagingSenderId: "457844478016",
  appId: "1:457844478016:web:7e576a496bea1fe03d8fa5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Player identity */
let playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

let name = localStorage.getItem("playerName") || "Player";
let role = localStorage.getItem("playerRole") || "hider";

const topBar = document.getElementById("topBar");
topBar.textContent = `${name} — ${role.toUpperCase()}`;

/* Settings handlers */
window.openSettings = () => {
  nameInput.value = name;
  roleInput.value = role;
  settingsModal.style.display = "flex";
};

window.closeSettings = () => {
  settingsModal.style.display = "none";
};

window.saveSettings = () => {
  name = nameInput.value.trim() || "Player";
  role = roleInput.value;

  localStorage.setItem("playerName", name);
  localStorage.setItem("playerRole", role);

  location.reload();
};

/* Map */
const map = L.map("map", { editable:true }).setView([6.033,80.216], 18);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom:20 }
).addTo(map);

L.tileLayer(
  "https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png",
  { maxZoom:20 }
).addTo(map);

/* Players */
const markers = {};

/* Location */
navigator.geolocation.watchPosition(pos => {
  set(ref(db,"players/"+playerId), {
    name,
    role,
    lat:pos.coords.latitude,
    lon:pos.coords.longitude,
    last:Date.now()
  });
});

/* Render players */
onValue(ref(db,"players"), snap => {
  const players = snap.val() || {};
  for (const id in players) {
    const p = players[id];
    const color = p.role === "seeker" ? "red" : "blue";

    const icon = L.divIcon({
      html:`<div style="background:${color};width:14px;height:14px;border-radius:50%"></div>
            <div style="font-size:12px;font-weight:600">${p.name}</div>`,
      iconSize:[14,14]
    });

    if (!markers[id]) {
      markers[id] = L.marker([p.lat,p.lon],{icon}).addTo(map);
    } else {
      markers[id].setLatLng([p.lat,p.lon]);
    }
  }
});

/* Seeker Zone */
let circle = null;
const slider = radiusSlider;
const value = radiusValue;
const box = radiusBox;

if (role === "seeker") box.style.display = "block";

onValue(ref(db,"game/zone"), snap => {
  const z = snap.val();
  if (!z) return;

  if (!circle) {
    circle = L.circle([z.lat,z.lon], {
      radius:z.radius,
      color:"red",
      fillOpacity:0.15
    }).addTo(map);

    if (role === "seeker") circle.enableEdit();
  } else {
    circle.setLatLng([z.lat,z.lon]);
    circle.setRadius(z.radius);
  }

  slider.value = z.radius;
  value.textContent = z.radius+" m";
});

if (role === "seeker") {
  map.on("editable:dragend", () => {
    const c = circle.getLatLng();
    set(ref(db,"game/zone"), {
      lat:c.lat,
      lon:c.lng,
      radius:circle.getRadius()
    });
  });

  slider.oninput = () => {
    value.textContent = slider.value+" m";
    circle.setRadius(slider.value);

    const c = circle.getLatLng();
    set(ref(db,"game/zone"), {
      lat:c.lat,
      lon:c.lng,
      radius:Number(slider.value)
    });
  };
}
</script>

</body>
</html>
