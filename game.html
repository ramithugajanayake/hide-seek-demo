<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hide & Seek â€“ Game</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Editable -->
<script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
}

#map {
  height: 100%;
  width: 100%;
}

/* ===== Player markers ===== */
.player-marker {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 3px solid white;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
}

.seeker-marker { background: #ff3b30; }
.hider-marker { background: #007aff; }

/* ===== UI ===== */
.glass {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(18px);
  padding: 10px 16px;
  border-radius: 18px;
  font-weight: 700;
  z-index: 1000;
}

.settings {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(18px);
  padding: 8px 12px;
  border-radius: 16px;
  cursor: pointer;
  z-index: 1000;
}

#radiusBox {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(18px);
  padding: 12px 16px;
  border-radius: 20px;
  display: none;
  z-index: 1000;
}

#settingsModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

#settingsModal > div {
  background: rgba(255,255,255,0.4);
  backdrop-filter: blur(20px);
  padding: 20px;
  border-radius: 20px;
  width: 260px;
}

input, select, button {
  width: 100%;
  margin-bottom: 10px;
  padding: 6px;
}
</style>
</head>

<body>

<div class="glass" id="topBar"></div>
<div class="settings" onclick="openSettings()">âš™ï¸</div>

<div id="radiusBox">
  <b>Zone Radius</b><br>
  <input type="range" id="radiusSlider" min="50" max="500" value="150">
  <span id="radiusValue">150 m</span>
  <br><br>
  <b>Zone Color</b><br>
  <button onclick="setZoneColor('red')">ğŸ”´</button>
  <button onclick="setZoneColor('orange')">ğŸŸ </button>
  <button onclick="setZoneColor('yellow')">ğŸŸ¡</button>
  <button onclick="setZoneColor('green')">ğŸŸ¢</button>
  <button onclick="setZoneColor('blue')">ğŸ”µ</button>
  <button onclick="setZoneColor('indigo')">ğŸŸ£</button>
  <button onclick="setZoneColor('violet')">ğŸŸª</button>
</div>

<div id="map"></div>

<!-- Settings -->
<div id="settingsModal">
  <div>
    <h3>Player Settings</h3>
    <label>Name</label>
    <input id="nameInput">
    <label>Role</label>
    <select id="roleInput">
      <option value="hider">Hider</option>
      <option value="seeker">Seeker</option>
    </select>
    <button onclick="saveSettings()">Save</button>
    <button onclick="closeSettings()">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "YOUR_PROJECT",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== Player identity ===== */
let playerId = localStorage.getItem("playerId") || crypto.randomUUID();
localStorage.setItem("playerId", playerId);

let name = localStorage.getItem("playerName") || "Player";
let role = localStorage.getItem("playerRole") || "hider";

topBar.textContent = `${name} â€” ${role.toUpperCase()}`;

/* ===== Settings ===== */
window.openSettings = () => {
  nameInput.value = name;
  roleInput.value = role;
  settingsModal.style.display = "flex";
};

window.closeSettings = () => settingsModal.style.display = "none";

window.saveSettings = () => {
  localStorage.setItem("playerName", nameInput.value || "Player");
  localStorage.setItem("playerRole", roleInput.value);
  location.reload();
};

/* ===== Map ===== */
const map = L.map("map", { editable: true }).setView([6.033, 80.216], 18);

L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 20 }
).addTo(map);

L.tileLayer(
  "https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png",
  { maxZoom: 20 }
).addTo(map);

/* ===== Marker factory ===== */
function getMarkerIcon(role) {
  return L.divIcon({
    className: "",
    html: `<div class="player-marker ${role}-marker"></div>`,
    iconSize: [14,14],
    iconAnchor: [7,7]
  });
}

const markers = {};

/* ===== Location tracking ===== */
navigator.geolocation.watchPosition(pos => {
  set(ref(db, "players/" + playerId), {
    name,
    role,
    lat: pos.coords.latitude,
    lon: pos.coords.longitude,
    last: Date.now()
  });
});

/* ===== Render players ===== */
onValue(ref(db, "players"), snap => {
  const players = snap.val() || {};
  for (const id in players) {
    const p = players[id];
    if (!markers[id]) {
      markers[id] = L.marker([p.lat, p.lon], {
        icon: getMarkerIcon(p.role)
      }).addTo(map)
        .bindPopup(`<b>${p.name}</b><br>${p.role}`);
    } else {
      markers[id].setLatLng([p.lat, p.lon]);
    }
  }
});

/* ===== Zone ===== */
let circle = null;

if (role === "seeker") radiusBox.style.display = "block";

onValue(ref(db, "game/zone"), snap => {
  const z = snap.val();
  if (!z) return;

  if (!circle) {
    circle = L.circle([z.lat, z.lon], {
      radius: z.radius,
      color: z.color,
      fillOpacity: 0.15
    }).addTo(map);

    if (role === "seeker") circle.enableEdit();
  } else {
    circle.setLatLng([z.lat, z.lon]);
    circle.setRadius(z.radius);
    circle.setStyle({ color: z.color });
  }

  radiusSlider.value = z.radius;
  radiusValue.textContent = z.radius + " m";
});

/* ===== Seeker controls ===== */
if (role === "seeker") {
  navigator.geolocation.getCurrentPosition(pos => {
    set(ref(db, "game/zone"), {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude,
      radius: 150,
      color: "red"
    });
  });

  radiusSlider.oninput = () => {
    if (!circle) return;
    circle.setRadius(radiusSlider.value);
    radiusValue.textContent = radiusSlider.value + " m";
    const c = circle.getLatLng();
    set(ref(db, "game/zone"), {
      lat: c.lat,
      lon: c.lng,
      radius: Number(radiusSlider.value),
      color: circle.options.color
    });
  };

  map.on("editable:dragend", () => {
    if (!circle) return;
    const c = circle.getLatLng();
    set(ref(db, "game/zone"), {
      lat: c.lat,
      lon: c.lng,
      radius: circle.getRadius(),
      color: circle.options.color
    });
  });
}

window.setZoneColor = color => {
  if (!circle) return;
  circle.setStyle({ color });
  const c = circle.getLatLng();
  set(ref(db, "game/zone"), {
    lat: c.lat,
    lon: c.lng,
    radius: circle.getRadius(),
    color
  });
};
</script>

</body>
</html>
