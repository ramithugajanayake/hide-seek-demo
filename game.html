<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hide & Seek - Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  body, html { height: 100%; margin: 0; font-family: 'Poppins', sans-serif; }
  #map { height: 100%; width: 100%; }

  /* Pulsing marker CSS */
  .pulse {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #ff3b3b;
    position: relative;
    box-shadow: 0 0 0 rgba(255,59,59,0.7);
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255,59,59,0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(255,59,59,0); }
    100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255,59,59,0); }
  }

  /* Header */
  #header {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.3);
    padding: 10px 20px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    z-index: 1000;
    font-weight: 600;
  }

  #header input {
    padding: 5px 10px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
  }
</style>
</head>
<body>

<div id="header">
  Your Name: <input type="text" id="playerName" placeholder="Enter name" />
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase JS SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyD259A37SrWNP8jaRP7h3NLKQMIAsr5jC4",
    authDomain: "hide-seek-demo-f6c65.firebaseapp.com",
    databaseURL: "https://hide-seek-demo-f6c65-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hide-seek-demo-f6c65",
    storageBucket: "hide-seek-demo-f6c65.firebasestorage.app",
    messagingSenderId: "457844478016",
    appId: "1:457844478016:web:7e576a496bea1fe03d8fa5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Player ID & Name
  let playerId = localStorage.getItem("playerId");
  if (!playerId) {
    playerId = 'player-' + Math.floor(Math.random() * 100000);
    localStorage.setItem("playerId", playerId);
  }

  const nameInput = document.getElementById("playerName");
  let playerName = localStorage.getItem("playerName") || '';

  if (!playerName) {
    playerName = prompt("Enter your player name:") || playerId;
    localStorage.setItem("playerName", playerName);
    nameInput.value = playerName;
  } else {
    nameInput.value = playerName;
  }

  // Map setup
  const map = L.map('map').setView([6.033, 80.216], 18);

  // Esri Satellite layer
  const satelliteLayer = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', 
    { attribution: 'Tiles &copy; Esri', maxZoom: 20 }
  ).addTo(map);

  // Stamen Labels overlay
  const labelsLayer = L.tileLayer(
    'https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png',
    { attribution: 'Map labels &copy; Stamen Design', maxZoom: 20 }
  ).addTo(map);

  const playerMarkers = {};

  // Update Player Location
  function updatePlayerLocation() {
    if (!navigator.geolocation) {
      alert("Geolocation not supported by your browser");
      return;
    }

    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      set(ref(db, `players/${playerId}`), {
        lat,
        lon,
        name: playerName,
        lastUpdate: Date.now()
      });

    }, err => alert("Location Error: " + err.message), { enableHighAccuracy: true });

    onDisconnect(ref(db, `players/${playerId}`)).remove();
  }

  updatePlayerLocation();

  // Name input listener
  nameInput.addEventListener("change", () => {
    playerName = nameInput.value.trim() || playerId;
    localStorage.setItem("playerName", playerName);
    updatePlayerLocation();
  });

  // Listen for all players
  onValue(ref(db, "players"), snapshot => {
    const players = snapshot.val() || {};
    for (const id in players) {
      const { lat, lon, name } = players[id];

      if (!playerMarkers[id]) {
        const pulseIcon = L.divIcon({
          className: '',
          html: `<div class="pulse"></div>
                 <div style="position:absolute;top:20px;left:-10px;color:black;font-weight:600;">${name}</div>`,
          iconSize: [18,18],
          iconAnchor: [9,9],
        });
        playerMarkers[id] = L.marker([lat, lon], {icon: pulseIcon}).addTo(map);
      } else {
        playerMarkers[id].setLatLng([lat, lon]);
        playerMarkers[id].setIcon(L.divIcon({
          className: '',
          html: `<div class="pulse"></div>
                 <div style="position:absolute;top:20px;left:-10px;color:black;font-weight:600;">${name}</div>`,
          iconSize: [18,18],
          iconAnchor: [9,9],
        }));
      }
    }
  });

</script>
</body>
</html>
