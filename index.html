<!DOCTYPE html>
<html>
<head>
  <title>Hide & Seek Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 90vh; width: 100%; }
    h2 { text-align: center; margin: 10px 0; }
  </style>
</head>
<body>

<h2>Hide & Seek Demo</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
  // ---------------- Firebase Setup ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD259A37SrWNP8jaRP7h3NLKQMIAsr5jC4",
    authDomain: "hide-seek-demo-f6c65.firebaseapp.com",
    databaseURL: "https://hide-seek-demo-f6c65-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hide-seek-demo-f6c65",
    storageBucket: "hide-seek-demo-f6c65.firebasestorage.app",
    messagingSenderId: "457844478016",
    appId: "1:457844478016:web:7e576a496bea1fe03d8fa5"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  // ---------------- Player Setup ----------------
  let playerId = localStorage.getItem("playerId");
  if (!playerId) {
    playerId = "Player_" + Math.floor(Math.random() * 1000);
    localStorage.setItem("playerId", playerId);
  }

  const playerMarkers = {};

  // ---------------- Map Setup ----------------
  const map = L.map('map').setView([6.033, 80.216], 16);

  // Satellite imagery
  const satellite = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community',
      maxZoom: 19
    }
  ).addTo(map);

  // Labels overlay (roads, cities, landmarks)
  const labels = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
    {
      attribution: 'Labels &copy; Esri',
      maxZoom: 19,
      opacity: 0.7
    }
  ).addTo(map);

  // ---------------- Track Location ----------------
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Write location to Firebase
      set(ref(database, `players/${playerId}`), {
        lat,
        lon,
        lastUpdate: Date.now()
      });

      // Remove on disconnect
      onDisconnect(ref(database, `players/${playerId}`)).remove();

      // Add/update marker
      if (!playerMarkers[playerId]) {
        playerMarkers[playerId] = L.marker([lat, lon])
          .addTo(map)
          .bindTooltip(playerId, { permanent: true, direction: 'top', offset: [0, -10] });
      } else {
        playerMarkers[playerId].setLatLng([lat, lon]);
      }

      // Optional: center map on yourself
      map.setView([lat, lon], 16);

    }, err => alert("Location error: " + err.message), { enableHighAccuracy: true });
  } else {
    alert("Geolocation is not supported by your browser.");
  }

  // ---------------- Listen to all players ----------------
  onValue(ref(database, "players"), snapshot => {
    const players = snapshot.val() || {};

    for (const id in players) {
      const { lat, lon } = players[id];

      if (!playerMarkers[id]) {
        playerMarkers[id] = L.marker([lat, lon])
          .addTo(map)
          .bindTooltip(id, { permanent: true, direction: 'top', offset: [0, -10] });
      } else {
        playerMarkers[id].setLatLng([lat, lon]);
      }
    }

    // Remove disconnected markers
    for (const id in playerMarkers) {
      if (!players[id]) {
        map.removeLayer(playerMarkers[id]);
        delete playerMarkers[id];
      }
    }
  });
</script>

</body>
</html>
